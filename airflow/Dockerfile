# Use Amazon Linux 2 as the base image, AMD64 architecture.
FROM --platform=linux/amd64 amazonlinux:2 AS base

# Install Python 3 on the Amazon Linux 2 base image.
RUN yum install -y python3

# Set an environment variable for the virtual environment directory.
ENV VIRTUAL_ENV=/opt/venv
# Create a Python virtual environment in the specified directory.
RUN python3 -m venv $VIRTUAL_ENV
# Update PATH environment variable to use the virtual environment's binaries.
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# Upgrade pip to the latest version and install specific versions of numpy,
# scipy, pandas, boto3, and venv-pack using pip.
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install \
    numpy==1.21.6 \
    scipy==1.7.3 \
    pandas==1.3.5 \
    boto3==1.26.62 \
    venv-pack==0.2.0

# Create an output directory and use venv-pack to package the virtual
# environment into a tar.gz file. This is useful for exporting the environment
# to be used elsewhere, such as in a Spark cluster.
RUN mkdir /output && venv-pack -o /output/pyspark_venv.tar.gz

# Start a new build stage from scratch to create a minimal final image.
FROM scratch AS export
# Copy the packaged virtual environment from the 'base' build stage to the
# 'export' stage.
COPY --from=base /output/pyspark_venv.tar.gz /