# End-to-End ML Pipeline for Malware Detection in Network Traffic

This repository is dedicated to showcasing an MLOps operation utilizing MLflow,
Spark, SageMaker, and Apache Airflow in a comprehensive machine learning
pipeline designed for the detection of malware in network traffic. Structured
into two primary directories, `notebooks/` and `airflow/`, this project
emphasizes operationalizing ML models efficiently and effectively. The
`airflow/` directory is pivotal, containing the automation and orchestration
components using Managed Apache Airflow (MWAA) on AWS.

## Directory Overview

For a comprehensive understanding of how each component integrates and operates
within this ML pipeline, refer to the linked README files in both the
`notebooks/` and `airflow/` directories.

- **`notebooks/`**: Contains experimental Jupyter notebooks used during the
  development of the ML pipeline. These notebooks facilitate data processing,
  exploration, and modeling. For more details, see the [notebooks
  README](notebooks/README.md).
- **`airflow/`**: Houses the configuration and scripts necessary to set up and
  manage the Airflow environment that orchestrates and automates the ML
  pipeline. For setup instructions and more information, refer to the [airflow
  README](airflow/README.md).

## Tools Used

The project integrates a variety of tools to manage data workflows and machine
learning lifecycle:

- **Amazon EMR and SageMaker Studio Classic**: Used within the notebooks for
  large-scale data processing with PySpark and machine learning lifecycle
  management.
- **MLflow and Amazon SageMaker**: Employed for tracking experiments, managing
  the machine learning lifecycle, and integrating with SageMaker for model
  deployment.
- **AWS Managed Apache Airflow (MWAA)**: Orchestrates and automates the ML
  pipeline, ensuring smooth and scalable operations.
- **Docker**: Provides consistent environments, crucial for replicating the
  setup across different stages of the pipeline.
- **AWS S3**: Stores scripts, configuration files, and data, serving as the
  backbone for data management in the cloud.
- **AWS IAM**: Manages access and permissions across AWS services, securing the
  pipeline and its components.

## Overview of the Notebooks
The `notebooks/` directory serves as the experimental hub:
- **`data-wrangling.ipynb`**: Conducts exploratory data analysis and feature
  engineering, laying the groundwork for modeling.
- **`modeling.ipynb`**: Focuses on the application of Bayesian hyperparameter
  optimization to select the classifier type yielding the highest average
  precisionâ€”a crucial metric chosen due to the imbalanced nature of the classes
  "Malicious" and "Benign". Unlike ROC-AUC, which may not provide reliable
  results for imbalanced datasets, average precision represents the area under
  the precision-recall curve, offering a more appropriate evaluation metric for
  this context.

### Insights and Model Dynamics

- **Main Insights**: Identification of three distinct anomalous behavior
  patterns in the dataset enriches the understanding and strategic approach
  towards effective malware detection.
- **Engineered Features**: Discusses crucial features such as aggregated network
  traffic statistics and protocol usage flags that critically enhance model
  accuracy.
- **Model Selection**: Details the model type chosen based on Bayesian
  hyperparameter optimization, focusing on average precision rather than ROC due
  to the data's imbalance.

### Areas Not Covered
- **Model Explainability**: There is no effort in `modeling.ipynb` to apply
  techniques like SHAP values for model explainability.
- **Business Metrics**: The notebooks do not set specific business metrics nor
  determine an optimal threshold for operational decisions.

## Dataset

The project utilizes the "Malware Detection in Network Traffic Data" dataset
from Kaggle, provided by Stratosphere Laboratory. This dataset is pivotal for
training and validating models that detect malware activities within network
traffic. It contains labeled data representing both malicious and benign network
events, which makes it suitable for developing and testing malware detection
systems.

### Dataset Details
- **Source**: The dataset is available on Kaggle through the following link:
  [Malware Detection in Network Traffic
  Data](https://www.kaggle.com/datasets/agungpambudi/network-malware-detection-connection-analysis).
- **Licensing**: Attribution 4.0 International (CC BY 4.0)
- **Citation**: "Stratosphere Laboratory. A labeled dataset with malicious and
  benign IoT network traffic. January 22th. Agustin Parmisano, Sebastian Garcia,
  Maria Jose Erquiaga.
  [https://www.stratosphereips.org/datasets-iot23](https://www.stratosphereips.org/datasets-iot23)."

### Dataset Description
The dataset includes comprehensive labels that detail connections linked to
potentially malicious activities, meticulously annotated by experts at
Stratosphere labs. Each label provides insights into the nature of the traffic,
whether it is normal or indicative of various types of network threats such as
Command and Control communications, DDoS attacks, or part of a horizontal port
scan.

#### Labels and Their Meanings:
- **Attack**: Indicates an attack from an infected device attempting to exploit
  vulnerabilities.
- **Benign**: Connections with no detected suspicious activities.
- **C&C (Command and Control)**: Connections to a C&C server, often marked by
  periodic communications.
- **DDoS (Distributed Denial of Service)**: Part of a DDoS attack, usually
  involving high volumes of traffic.
- **FileDownload**: Large file downloads from suspicious sources.
- **HeartBeat**: Regular, small packet exchanges that keep the connection to a
  C&C server alive.
- **Mirai/Okiru/Torii**: Connections exhibiting patterns typical of these known
  botnets.
- **PartOfAHorizontalPortScan**: Connections that are part of an attempt to
  discover open ports across multiple devices.

#### Data Fields:
The dataset comprises several fields such as timestamps, unique identifiers,
source and destination IPs and ports, protocol types, service details,
connection states, packet and byte counts, and detailed labels describing the
connection's nature.